---
- hosts: all
  become: yes

  vars:
    certbot_admin_email: "admin@example.com"
    certbot_create_if_missing: true
    certbot_create_standalone_stop_services:
    - httpd
    certbot_certs:
    - domains:
      - "server.example.com"
    apache_server_name: "server.example.com"
    apache_default_admin_email: "admin@example.com"
    apache_copy_ssl_files: false
    apache_ssl_cert_file_location: "/etc/letsencrypt/live/{{ apache_server_name }}/fullchain.pem"
    apache_ssl_cert_key_location: "/etc/letsencrypt/live/{{ apache_server_name }}/privkey.pem"
    apache_proxy_host: "localhost"
    apache_proxy_port: 8080
    default_context_path: "/"

  pre_tasks:
    - name: Update apt cache.
      apt: update_cache=true cache_valid_time=600
      when: ansible_os_family == 'Debian'
      changed_when: false

    - name: Install dependencies (RedHat).
      yum: name={{ item }} state=present
      when: ansible_os_family == 'RedHat'
      with_items:
        - cronie
        - epel-release

    - name: Install cron (Debian).
      apt: name=cron state=present
      when: ansible_os_family == 'Debian'

  roles:
    - ansible-role-certbot
    - ansible-role-proxy


